
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Customizing miteʼs stats &#8212; mite  documentation</title>
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/graphviz.css" />
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/language_data.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Prometheus and mite" href="prometheus.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="customizing-mites-stats">
<h1>Customizing miteʼs stats<a class="headerlink" href="#customizing-mites-stats" title="Permalink to this headline">¶</a></h1>
<p>There are two components of the mite pipeline that are concerned with
the reporting of test data: the stats component and the prometheus
exporter.  The prometheus exporter works in a fully automatic way, based
on the behavior of the stats component.  Therefore, when customizing the
statistics that mite exports, it is sufficient to work on the stats
component; the prometheus exporter will do the right thing.</p>
<p>Mite stats are registered as <a class="reference external" href="https://amir.rachum.com/blog/2017/07/28/python-entry-points/">entry points</a> in python.  Therefore, any
modules that you install that extend miteʼs stats will automatically be
picked up when the stats process starts.  It logs a message for each
moduleʼs stats that it finds, so you will know exactly what is loaded.</p>
<div class="section" id="writing-custom-stats">
<h2>Writing custom stats<a class="headerlink" href="#writing-custom-stats" title="Permalink to this headline">¶</a></h2>
<p>Prometheus, miteʼs chosen data backend, supports three different kinds
of metrics: a Gauge, a Counter, and a Histogram.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Prometheus also supports a Summary metric type, but this is just (for
our purposes) a less performant version of a Histogram, so it will nt
be further discussed.</p>
</div>
<p>Each of these is exposed as a class in the <code class="docutils literal notranslate"><span class="pre">mite.stats</span></code> module.  When
instantiating one of these classes to create a custom metric, you will
need to supply a name, a matcher, and an extractor.  The name is
directly translated into the prometheus name for the metric, so it is
useful for it to start with <code class="docutils literal notranslate"><span class="pre">mite_</span></code> so that related metrics will be
grouped together (especially if the prometheus instance that collects
your mite metrics also collects other data, like CPU and memory usage of
application processes).</p>
<p>The stats component acts by processing a stream of messages generated by
the runner and controller.  The matcher is a function that filters these
messages, determining which are of interest to a particular stat and
which it can ignore.  Because each message has a <code class="docutils literal notranslate"><span class="pre">type</span></code> field, it is
often useful to match on the value of that field, which is the purpose
of the included <code class="docutils literal notranslate"><span class="pre">mite.stats.matcher_by_type</span></code> function.  (However, the
matcher receives the entire message dict as an argument, and can perform
arbitrary computation on its contents if it wishes.)</p>
<p>The extractor function operates on the messages that have been selected
by the matcher.  The extractor pulls out some labels from the message,
which will be added as labels to the time series in prometheus.  It is
also, in most cases, responsible for extracting a numerical value from
the message.  (The exception is stats of the Counter type, which count
the occurrences of a particular message type.  There, no value dependent
on the message is needed, as the value of the counter is always
incremented by one).  The built-in <code class="docutils literal notranslate"><span class="pre">mite.stats.extractor</span></code> function
covers most use-cases.  It takes two arguments.  The first is a sequence
of strings, which will be extracted as keys from the message
dictionary.  The values of these keys will be used as the labels on the
prometheus metric.  The second argument is a single string, which names
the dictionary key containing the numeric value to be accumulated.  For
more advanced usages, it will be necessary to construct a
<code class="docutils literal notranslate"><span class="pre">mite.stats.Extractor</span></code> class directly.  See
<code class="docutils literal notranslate"><span class="pre">mite.stats.controller_report_extractor</span></code> for an example of this.</p>
<p>Here is an example of a custom stat from our work on AMQP testing:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_amqp_extract</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;total_received&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">yield</span> <span class="p">(</span><span class="n">key</span><span class="p">,),</span> <span class="n">value</span>


<span class="n">_MITE_STATS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">Gauge</span><span class="p">(</span>
        <span class="s2">&quot;mite_amqp_tx_stats&quot;</span><span class="p">,</span>
        <span class="n">matcher_by_type</span><span class="p">(</span><span class="s2">&quot;amqp_tx_stats&quot;</span><span class="p">),</span>
        <span class="n">extractor</span><span class="p">([</span><span class="s2">&quot;message_name&quot;</span><span class="p">],</span> <span class="s2">&quot;total_sent&quot;</span><span class="p">)</span>
    <span class="p">),</span>
    <span class="n">Gauge</span><span class="p">(</span>
        <span class="s2">&quot;mite_amqp_rx_stats&quot;</span><span class="p">,</span>
        <span class="n">matcher_by_type</span><span class="p">(</span><span class="s2">&quot;amqp_rx_stats&quot;</span><span class="p">),</span>
        <span class="n">Extractor</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;message_name&quot;</span><span class="p">],</span> <span class="n">extract</span><span class="o">=</span><span class="n">_amqp_extract</span><span class="p">)</span>
    <span class="p">)</span>
<span class="p">]</span>
</pre></div>
</div>
<p>In our AMQP injection functions, we send two messages.  The first,
<code class="docutils literal notranslate"><span class="pre">amqp_tx_stats</span></code>, names a <code class="docutils literal notranslate"><span class="pre">message_name</span></code> and contains a
<code class="docutils literal notranslate"><span class="pre">total_sent</span></code> value.  That is extracted into a Gauge by the first
stat.  Because each <code class="docutils literal notranslate"><span class="pre">message_name</span></code> is represented by a separate
message, this is a simple stat.  The second is the <code class="docutils literal notranslate"><span class="pre">mite_rx_stats</span></code>.
This message is send by the worker coroutine that drains the AMQP
queues.  Once a second, it reports on the total number of messages it
has received – of all types.  Therefore, we need to write a custom
<code class="docutils literal notranslate"><span class="pre">_amqp_extract</span></code> function, which will yield a sequence of <code class="docutils literal notranslate"><span class="pre">(key,</span>
<span class="pre">value)</span></code> tuples.</p>
<p>We also need to inform mite about our stats, using pythonʼs entry points
mechanism.  To do so, we add a section to the <code class="docutils literal notranslate"><span class="pre">setup.cfg</span></code> file for our
package:</p>
<div class="highlight-cfg notranslate"><div class="highlight"><pre><span></span><span class="k">[options.entry_points]</span>
<span class="na">mite_stats</span> <span class="o">=</span><span class="s"></span>
<span class="s">    mite_amqp = id_mite_nft.amqp:_MITE_STATS</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It is also possible to specify the equivalent information in
<code class="docutils literal notranslate"><span class="pre">setup.py</span></code> if that is the configuration file your project uses.</p>
</div>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">mite</a></h1>






<p>
<iframe src="https://ghbtns.com/github-btn.html?user=sky-uk&repo=mite&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="components.html">Mite components</a></li>
<li class="toctree-l1"><a class="reference internal" href="journeys.html">Writing mite journeys and scenarios</a></li>
<li class="toctree-l1"><a class="reference internal" href="volume-model.html">Volume model specification</a></li>
<li class="toctree-l1"><a class="reference internal" href="config.html">Specifying configuration for mite journeys</a></li>
<li class="toctree-l1"><a class="reference internal" href="design-deployment.html">Design and deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="prometheus.html">Prometheus and mite</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Customizing miteʼs stats</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#writing-custom-stats">Writing custom stats</a></li>
</ul>
</li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="prometheus.html" title="previous chapter">Prometheus and mite</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Sky UK - Identity performance engineers.
      
      |
      <a href="_sources/stats.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    
    <a href="https://github.com/sky-uk/mite" class="github">
        <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"  class="github"/>
    </a>
    

    
  </body>
</html>